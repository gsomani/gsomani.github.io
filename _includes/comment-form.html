<script type="module">
import { Octokit } from "https://esm.sh/@octokit/rest";
const octokit = new Octokit({ auth: 'github_pat_{{site.token}}'});

const owner = "{{site.owner}}";
const repo = "{{site.blog_repo}}";
const issueNumber = {{page.issue}};

function createIssueComment(name, data) {
 
  const commentJSON = {name: name, data: data};

  octokit.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
    owner,
    repo,
    issue_number: issueNumber,
    body: JSON.stringify(commentJSON)
  }).then(response => {
    alert('Comment created successfully!');
  }).catch(error => {
    alert('Error creating comment');
  });
}

function extractComment(comments)
{
  var data = new Array();

  for (const [key, value] of Object.entries(comments))
  {
    var cur = JSON.parse(value.body);
    cur['date'] = value.created_at;
    data.append(cur);
  }
  return data;
}

function readIssueComments() {
  octokit.request('GET /repos/{owner}/{repo}/issues/{issue_number}/comments', {
    owner,
    repo,
    issue_number: issueNumber
  }).then(response => {
    console.log('Comments:', extractComment(response.data));
  }).catch(error => {
    console.error('Error fetching comments:', error);
  });
}

window.createIssueComment = createIssueComment;
window.readIssueComments = readIssueComments;

</script>


<form id="commentForm" action="" class="comment-form">
  <input id="honeypot" name="honeypot" type="text" /> 

<input
      class="comment-name"
      name="name"
      type="text"
      placeholder="Name"
      required
    />

{% if page.layout == 'journal' %}

{% elsif page.title == 'contact' %}
   <input
      class="comment-name"
      name="email"
      type="email"
      placeholder="Email"
      required
    />
{% else %}

   <input
      class="comment-name"
      name="email"
      type="email"
      placeholder="Email(optional)"
    />

{% endif %}

  <textarea
    class="comment-message"
    name="message"
    id="comment-message"
    placeholder="Comment (markdown accepted)"
    required
  ></textarea>
    
  <button class="comment-submit" >
    SEND
  </button>
</form>

<script>
  var simplemde = new SimpleMDE({
    element: document.getElementById("comment-message"),
    forceSync: true,
    spellChecker: false,
    status: false,
    placeholder: "Comment (markdown supported)",
  });


  let commentForm = document.getElementById("commentForm");
console.log(commentForm);

commentForm.addEventListener("submit", (e) => {
  e.preventDefault();

        var form = e.target;
        var formData = new FormData(form);

        var honeypot = formData.get('honeypot');
        if (honeypot)
          return;

        createIssueComment(formData.get('name'), formData.get('message'));
        readIssueComments();
});

</script>
